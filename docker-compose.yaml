services:
  # --- BANCOS DE DADOS ---
  marketplace-db:
    image: postgres:16
    container_name: marketplace-db
    restart: always
    environment:
      POSTGRES_USER: ${MP_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${MP_DB_PASS:-postgres}
      POSTGRES_DB: ${MP_DB_NAME:-marketplace_db}
    ports:
      - "${MP_BD_PORT:-5432}:5432"
    volumes:
      - marketplace_pgdata:/var/lib/postgresql/data

  social-midia-db:
    image: postgres:16
    container_name: social-midia-db
    restart: always
    environment:
      POSTGRES_USER: ${SM_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${SM_DB_PASS:-postgres}
      POSTGRES_DB: ${SM_DB_NAME:-social_midia_db}
    ports:
      - "${SM_BD_PORT:-5433}:5432"
    volumes:
      - social_midia_pgdata:/var/lib/postgresql/data

  teleconsulta-db:
    image: postgres:16
    container_name: teleconsulta-db
    restart: always
    environment:
      POSTGRES_USER: ${TC_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${TC_DB_PASS:-postgres}
      POSTGRES_DB: ${TC_DB_NAME:-teleconsulta_db}
    ports:
      - "${TC_BD_PORT:-5434}:5432"
    volumes:
      - teleconsulta_pgdata:/var/lib/postgresql/data

  users-isaude-db:
    image: postgres:16
    container_name: users-isaude-db
    restart: always
    environment:
      POSTGRES_USER: ${USER_DB_USER:-postgres}
      POSTGRES_PASSWORD: ${USER_DB_PASS:-postgres}
      POSTGRES_DB: ${USER_DB_NAME:-users_isaude_db}
    ports:
      - "${USER_BD_PORT:-5435}:5432"
    volumes:
      - users_isaude_pgdata:/var/lib/postgresql/data

  # --- REDIS (para API de Usuários) ---
  users-isaude-redis:
    image: redis:alpine
    container_name: users-isaude-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - users_isaude_redisdata:/data

  # --- API de Usuários/Pacientes ---
  users-api:
    build: ./usu-rios-pacientes-master
    container_name: users-isaude-back-end
    restart: unless-stopped
    env_file:
      - ./usu-rios-pacientes-master/.env
    ports:
      - "8081:80"
    volumes:
      - ./usu-rios-pacientes-master:/src
      # --- CORREÇÃO ADICIONADA AQUI ---
      # Mapeia o serviceAccountKey.json para dentro do contêiner
      - ./usu-rios-pacientes-master/serviceAccountKey.json:/src/serviceAccountKey.json
      - /src/node_modules
    depends_on:
      - users-isaude-db
      - users-isaude-redis
    command: npm run dev

  # --- API de Marketplace ---
  marketplace-api:
    build: ./I-sa-de-MARKETPLACE-master
    container_name: marketplace-back-end
    restart: unless-stopped
    env_file:
      - ./I-sa-de-MARKETPLACE-master/.env
    ports:
      - "8082:80"
    volumes:
      - ./I-sa-de-MARKETPLACE-master:/src
      - /src/node_modules
    depends_on:
      - marketplace-db
    command: npm run dev

  # --- API de Social Feed ---
  social-feed-api:
    build: ./I-sa-de-social-feed-master
    container_name: social-midia-back-end
    restart: unless-stopped
    env_file:
      - ./I-sa-de-social-feed-master/.env
    ports:
      - "8083:80"
    volumes:
      - ./I-sa-de-social-feed-master:/src
      - /src/node_modules
    depends_on:
      - social-midia-db
    command: npm run dev

  # --- API de Teleconsulta ---
  teleconsulta-api:
    build: ./I-sa-de-teleconsultas-master
    container_name: teleconsulta-back-end
    restart: unless-stopped
    env_file:
      - ./I-sa-de-teleconsultas-master/.env
    ports:
      - "8084:80"
    volumes:
      - ./I-sa-de-teleconsultas-master:/src
      - /src/node_modules
    depends_on:
      - teleconsulta-db
    command: npm run dev

  # --- API Gateway (BFF) ---
  bff-api:
    build: ./I-sa-de-BBF-master
    container_name: bff-isaude
    restart: unless-stopped
    env_file:
      - ./I-sa-de-BBF-master/.env
    ports:
      - "8080:80" # <-- PONTO DE ENTRADA PRINCIPAL
    volumes:
      - ./I-sa-de-BBF-master:/src
      - /src/node_modules
    depends_on:
      - users-api
      - marketplace-api
      - social-feed-api
      - teleconsulta-api
    command: npm run dev

# Define os volumes nomeados para persistência
volumes:
  marketplace_pgdata:
  social_midia_pgdata:
  teleconsulta_pgdata:
  users_isaude_pgdata:
  users_isaude_redisdata:

